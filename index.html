<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kenz Ramadan Treasure Hunt</title>
  <style>
    @font-face {
      font-family: 'BahijTheSansArabic';
      src: url('assets/Bahij_TheSansArabic-Plain.ttf') format('truetype');
    }
    body {
      font-family: 'BahijTheSansArabic', sans-serif;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(50, 50, 50, 0.5));
      margin: 0;
      padding: 0;
      direction: rtl;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    #app {
      position: relative;
      width: 90%;
      height: 80vh;
      max-width: 600px;
      background: #FF9000;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      padding: 50px 10px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    button.close-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: transparent;
      border: none;
      font-size: 40px;
      cursor: pointer;
      color: #FFFFFF;
      font-weight: 200;
    }
    #globalProgressBar {
      position: relative;
      top: 60px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #progressContainer {
      margin: 0 auto;
      width: calc(100% - 20px);
      height: 16px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    #progressContainer::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(150deg, #ffffff, #ffffff 32px, #f0f0f0 32px, #f0f0f0 64px);
      background-size: 200% 100%;
      animation: stripes-left 12s linear infinite;
      z-index: 0;
    }
    #progress {
      position: relative;
      z-index: 1;
      width: 0%;
      height: 100%;
      background: repeating-linear-gradient(135deg, #470C79, #470C79 8px, #5A1D93 8px, #5A1D93 16px);
      background-size: 200% 100%;
      border-radius: 8px;
      transition: width 0.6s ease-in-out;
      animation: stripes-left 12s linear infinite;
    }
    #progress.complete { background: #470C79; animation: none; }
    @keyframes stripes-left { 0%{background-position:0% 0;} 100%{background-position:200% 0;} }
    .screen {
      padding: 20px;
      margin: 60px 0px;
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .screen.active { opacity: 1; transform: translateY(0); }
    h1 { color: #fff; font-size: 32px; font-weight: bold; }
    h2 { color: #fff; font-size: 18px; font-weight: bold; }
    h4 { color: #000; font-size: 18px; }
    p { color: #555; line-height: 1.5; font-size: 16px; }
    .mission {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      padding: 15px;
      margin: 15px 0;
      text-align: right;
    }
    input[type="text"] {
      width: calc(100% - 24px);
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      text-align: center;
      outline: none;
    }
    button.cta {
      background-color: #00C150;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 10px 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button.cta:hover { background-color: #FDC749; }
    .feedback.correct { color: #00C150; }
    .feedback.incorrect { color: #E40031; }
    #moonIcon {
      position: fixed; top: 10%; left: 10%; height: 100px; z-index: 2000;
    }
    #chestIcon {
      position: fixed; bottom: 15%; right: 8%; height: 150px; z-index: 2000;
    }
    #celebrationOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 3000; display: none;
    }
    .celebration-icon {
      position: absolute; top: -50px; font-size: 2rem;
      animation: popFall 2s ease-out forwards;
    }
    @keyframes popFall {
      0%{opacity:0;transform:translateY(0)scale(0.5);}
      20%{opacity:1;transform:translateY(20px)scale(1.2);}
      100%{opacity:0;transform:translateY(100vh)scale(1);}
    }
  </style>
</head>
<body>

  <img src="assets/moon.png" id="moonIcon" alt="Moon Icon">
  <img src="assets/chest.png" id="chestIcon" alt="Chest Icon">
  <div id="celebrationOverlay"></div>
  <audio id="celebrationSound" src="https://www.dropbox.com/scl/fi/w4kgojja99wroki71a7zp/tada-sound.mp3?raw=1"></audio>

  <div id="app">
    <button class="close-btn" onclick="closeGame()">×</button>
    <div id="globalProgressBar">
      <div id="progressContainer"><div id="progress"></div></div>
    </div>

    <div id="welcomeScreen" class="screen active">
      <h1>كنز كوينز</h1>
      <p>مرحبًا بك في رحلة البحث عن الكنز! حل الألغاز وافتح الخصومات 🎁</p>
      <button id="startHunt" class="cta">ابدأ المغامرة</button>
    </div>

    <!-- Level 1 -->
    <div id="level1" class="screen" style="display:none;">
      <h2>🟢 المستوى الأول</h2>
      <div class="mission" id="l1Mission1">
        <h4>المهمة الأولى</h4>
        <p>ما هو أول حرف من كلمة "كنز"؟</p>
        <input type="text" id="l1m1Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(1,1)">إرسال</button>
        <p class="feedback" id="l1m1Feedback"></p>
      </div>
      <div class="mission" id="l1Mission2" style="display:none;">
        <h4>المهمة الثانية</h4>
        <p>كم عدد أحرف كلمة كوينز؟</p>
        <input type="text" id="l1m2Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(1,2)">إرسال</button>
        <p class="feedback" id="l1m2Feedback"></p>
      </div>
      <div class="mission" id="l1Mission3" style="display:none;">
        <h4>المهمة الثالثة</h4>
        <p>اكتب كلمة "رمضان" بالعربية</p>
        <input type="text" id="l1m3Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(1,3)">إرسال</button>
        <p class="feedback" id="l1m3Feedback"></p>
      </div>
      <div id="l1Completion" style="display:none;">
        <p>مبروك 🎉 حصلت على خصم 20%</p>
        <button class="cta" onclick="proceedToLevel(2)">التالي</button>
      </div>
    </div>

    <!-- Level 2 -->
    <div id="level2" class="screen" style="display:none;">
      <h2>🟡 المستوى الثاني</h2>
      <div class="mission" id="l2Mission1">
        <h4>المهمة الأولى</h4>
        <p>ما هو لون شعار كوينز الأساسي؟</p>
        <input type="text" id="l2m1Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(2,1)">إرسال</button>
        <p class="feedback" id="l2m1Feedback"></p>
      </div>
      <div class="mission" id="l2Mission2" style="display:none;">
        <h4>المهمة الثانية</h4>
        <p>كم عدد مستويات الكنز؟</p>
        <input type="text" id="l2m2Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(2,2)">إرسال</button>
        <p class="feedback" id="l2m2Feedback"></p>
      </div>
      <div class="mission" id="l2Mission3" style="display:none;">
        <h4>المهمة الثالثة</h4>
        <p>اكتب كلمة "كنز" بالإنجليزية</p>
        <input type="text" id="l2m3Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(2,3)">إرسال</button>
        <p class="feedback" id="l2m3Feedback"></p>
      </div>
      <div id="l2Completion" style="display:none;">
        <p>رائع 🎉 حصلت على خصم 30%</p>
        <button class="cta" onclick="proceedToLevel(3)">التالي</button>
      </div>
    </div>

    <!-- Level 3 -->
    <div id="level3" class="screen" style="display:none;">
      <h2>🔴 المستوى الثالث</h2>
      <div class="mission" id="l3Mission1">
        <h4>المهمة الأولى</h4>
        <p>اكتب كلمة "كنز كوينز" كاملة</p>
        <input type="text" id="l3m1Answer" placeholder="اكتب الإجابة هنا...">
        <button class="cta" onclick="checkAnswer(3,1)">إرسال</button>
        <p class="feedback" id="l3m1Feedback"></p>
      </div>
      <div id="l3Completion" style="display:none;">
        <p>مبروك 🎉 أكملت اللعبة كلها! حصلت على خصم 40%</p>
        <button class="cta" onclick="finishHunt()">إنهاء اللعبة</button>
      </div>
    </div>

    <!-- Final -->
    <div id="finalScreen" class="screen" style="display:none;">
      <h2>شكرًا لمشاركتك!</h2>
      <p>استمتع بخصمك وراقب السحب القادم 💰</p>
      <button class="cta" onclick="resetGame()">إعادة اللعب</button>
    </div>
  </div>

<script>
  // --- LocalStorage progress ---
  let userProgress = localStorage.getItem("kenz_progress") || "l1m1";
  const feedbackDelay = 1000;
  const answers = {
    1:{1:["ك"],2:["5","٥"],3:["رمضان"]},
    2:{1:["برتقالي","أورنج"],2:["3","٣"],3:["kenz"]},
    3:{1:["كنز كوينز"]}
  };
  let completedMissions = 0;

  function normalize(s){return s.toLowerCase().replace(/\s+/g,"").trim();}
  function checkAnswer(level,mission){
    const input=document.getElementById(`l${level}m${mission}Answer`);
    const feedback=document.getElementById(`l${level}m${mission}Feedback`);
    const val=normalize(input.value);
    const valid=answers[level][mission].some(a=>normalize(a)===val);
    if(valid){
      feedback.innerText="صحيح! 🎉";
      feedback.className="feedback correct";
      completedMissions++;
      updateProgressBar();
      setTimeout(()=>advanceMission(level,mission),feedbackDelay);
      triggerCelebration();
      localStorage.setItem("kenz_progress",`l${level}m${mission+1}`);
    }else{
      feedback.innerText="خطأ، حاول مجددًا.";
      feedback.className="feedback incorrect";
    }
  }

  function advanceMission(level,mission){
    if(level===1){
      if(mission===1){showMission(1,2);}
      else if(mission===2){showMission(1,3);}
      else{document.getElementById("l1Mission3").style.display="none";document.getElementById("l1Completion").style.display="block";}
    }else if(level===2){
      if(mission===1){showMission(2,2);}
      else if(mission===2){showMission(2,3);}
      else{document.getElementById("l2Mission3").style.display="none";document.getElementById("l2Completion").style.display="block";}
    }else if(level===3){
      document.getElementById("l3Mission1").style.display="none";
      document.getElementById("l3Completion").style.display="block";
    }
  }

  function showMission(level,mission){
    for(let i=1
